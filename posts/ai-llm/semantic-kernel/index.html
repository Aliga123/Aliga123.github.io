<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Semantic Kernel | aliga&#39;s Blog</title>
<meta name="keywords" content="">
<meta name="description" content="Semantic Kernel Sematic Kernel é€šè¿‡ Kernel é“¾æ¥ LLM ä¸ Functionsï¼ˆåŠŸèƒ½ï¼‰: Semantic Functionsï¼šé€šè¿‡ Prompt å®ç°çš„ LLM èƒ½åŠ› Native Functions: ç¼–ç¨‹è¯­è¨€åŸç”Ÿçš„å‡½æ•°åŠŸèƒ½ åœ¨ SK ä¸­ï¼Œä¸€ç»„ Function ç»„æˆä¸€ä¸ªæŠ€èƒ½ï¼ˆSkill/Pluginï¼‰ã€‚è¦è¿è¡Œ Skill/Pluginï¼Œéœ€è¦æœ‰ä¸€ä¸ªé…ç½®å’Œç®¡ç†çš„å•å…ƒï¼Œè¿™ä¸ªç»„ç»‡ç®¡ç†å•å…ƒå°±æ˜¯ Kernelã€‚ Kernel è´Ÿè´£ç®¡ç†åº•å±‚">
<meta name="author" content="aliga">
<link rel="canonical" href="https://Aliga123.github.io/posts/ai-llm/semantic-kernel/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.js" onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://Aliga123.github.io/img/Q.gif">
<link rel="icon" type="image/png" sizes="16x16" href="https://Aliga123.github.io/img/Q.gif">
<link rel="icon" type="image/png" sizes="32x32" href="https://Aliga123.github.io/img/Q.gif">
<link rel="apple-touch-icon" href="https://Aliga123.github.io/img/Q.gif">
<link rel="mask-icon" href="https://Aliga123.github.io/img/Q.gif">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://Aliga123.github.io/posts/ai-llm/semantic-kernel/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<script defer src="https://unpkg.com/mermaid@8.8.1/dist/mermaid.min.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
<script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.3/dist/jquery.min.js"></script>



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = ""; 
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

  

<meta property="og:title" content="Semantic Kernel" />
<meta property="og:description" content="Semantic Kernel Sematic Kernel é€šè¿‡ Kernel é“¾æ¥ LLM ä¸ Functionsï¼ˆåŠŸèƒ½ï¼‰: Semantic Functionsï¼šé€šè¿‡ Prompt å®ç°çš„ LLM èƒ½åŠ› Native Functions: ç¼–ç¨‹è¯­è¨€åŸç”Ÿçš„å‡½æ•°åŠŸèƒ½ åœ¨ SK ä¸­ï¼Œä¸€ç»„ Function ç»„æˆä¸€ä¸ªæŠ€èƒ½ï¼ˆSkill/Pluginï¼‰ã€‚è¦è¿è¡Œ Skill/Pluginï¼Œéœ€è¦æœ‰ä¸€ä¸ªé…ç½®å’Œç®¡ç†çš„å•å…ƒï¼Œè¿™ä¸ªç»„ç»‡ç®¡ç†å•å…ƒå°±æ˜¯ Kernelã€‚ Kernel è´Ÿè´£ç®¡ç†åº•å±‚" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://Aliga123.github.io/posts/ai-llm/semantic-kernel/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-07-28T00:18:23+08:00" />
<meta property="article:modified_time" content="2024-07-28T00:18:23+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Semantic Kernel"/>
<meta name="twitter:description" content="Semantic Kernel Sematic Kernel é€šè¿‡ Kernel é“¾æ¥ LLM ä¸ Functionsï¼ˆåŠŸèƒ½ï¼‰: Semantic Functionsï¼šé€šè¿‡ Prompt å®ç°çš„ LLM èƒ½åŠ› Native Functions: ç¼–ç¨‹è¯­è¨€åŸç”Ÿçš„å‡½æ•°åŠŸèƒ½ åœ¨ SK ä¸­ï¼Œä¸€ç»„ Function ç»„æˆä¸€ä¸ªæŠ€èƒ½ï¼ˆSkill/Pluginï¼‰ã€‚è¦è¿è¡Œ Skill/Pluginï¼Œéœ€è¦æœ‰ä¸€ä¸ªé…ç½®å’Œç®¡ç†çš„å•å…ƒï¼Œè¿™ä¸ªç»„ç»‡ç®¡ç†å•å…ƒå°±æ˜¯ Kernelã€‚ Kernel è´Ÿè´£ç®¡ç†åº•å±‚"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [

        {
          "@type": "ListItem",
          "position":  1 ,
          "name": "ğŸ“šæ–‡ç« ",
          "item": "https://Aliga123.github.io/posts/"
        },

        {
          "@type": "ListItem",
          "position":  2 ,
          "name": "ğŸ§± AIå¤§æ¨¡å‹åº”ç”¨å¼€å‘",
          "item": "https://Aliga123.github.io/posts/ai-llm/"
        }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "Semantic Kernel",
      "item": "https://Aliga123.github.io/posts/ai-llm/semantic-kernel/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Semantic Kernel",
  "name": "Semantic Kernel",
  "description": "Semantic Kernel Sematic Kernel é€šè¿‡ Kernel é“¾æ¥ LLM ä¸ Functionsï¼ˆåŠŸèƒ½ï¼‰: Semantic Functionsï¼šé€šè¿‡ Prompt å®ç°çš„ LLM èƒ½åŠ› Native Functions: ç¼–ç¨‹è¯­è¨€åŸç”Ÿçš„å‡½æ•°åŠŸèƒ½ åœ¨ SK ä¸­ï¼Œä¸€ç»„ Function ç»„æˆä¸€ä¸ªæŠ€èƒ½ï¼ˆSkill/Pluginï¼‰ã€‚è¦è¿è¡Œ Skill/Pluginï¼Œéœ€è¦æœ‰ä¸€ä¸ªé…ç½®å’Œç®¡ç†çš„å•å…ƒï¼Œè¿™ä¸ªç»„ç»‡ç®¡ç†å•å…ƒå°±æ˜¯ Kernelã€‚ Kernel è´Ÿè´£ç®¡ç†åº•å±‚",
  "keywords": [
    ""
  ],
  "articleBody": "Semantic Kernel Sematic Kernel é€šè¿‡ Kernel é“¾æ¥ LLM ä¸ Functionsï¼ˆåŠŸèƒ½ï¼‰:\nSemantic Functionsï¼šé€šè¿‡ Prompt å®ç°çš„ LLM èƒ½åŠ› Native Functions: ç¼–ç¨‹è¯­è¨€åŸç”Ÿçš„å‡½æ•°åŠŸèƒ½ åœ¨ SK ä¸­ï¼Œä¸€ç»„ Function ç»„æˆä¸€ä¸ªæŠ€èƒ½ï¼ˆSkill/Pluginï¼‰ã€‚è¦è¿è¡Œ Skill/Pluginï¼Œéœ€è¦æœ‰ä¸€ä¸ªé…ç½®å’Œç®¡ç†çš„å•å…ƒï¼Œè¿™ä¸ªç»„ç»‡ç®¡ç†å•å…ƒå°±æ˜¯ Kernelã€‚\nKernel è´Ÿè´£ç®¡ç†åº•å±‚æ¥å£ä¸è°ƒç”¨é¡ºåºï¼Œä¾‹å¦‚ï¼šOpenAI/Azure OpenAI çš„æˆæƒä¿¡æ¯ã€é»˜è®¤çš„ LLM æ¨¡å‹é€‰æ‹©ã€å¯¹è¯ä¸Šä¸‹æ–‡ã€æŠ€èƒ½å‚æ•°çš„ä¼ é€’ç­‰ç­‰ã€‚\nå¯¼å…¥å¸¸ç”¨çš„åº“ import os from dotenv import load_dotenv, find_dotenv import asyncio import logging from semantic_kernel import Kernel from semantic_kernel.functions import kernel_function from semantic_kernel.connectors.ai.open_ai import AzureChatCompletion from semantic_kernel.connectors.ai.open_ai import OpenAIChatCompletion from semantic_kernel.connectors.ai.function_call_behavior import FunctionCallBehavior from semantic_kernel.connectors.ai.chat_completion_client_base import ChatCompletionClientBase from semantic_kernel.contents.chat_history import ChatHistory from semantic_kernel.functions.kernel_arguments import KernelArguments from semantic_kernel.connectors.ai.open_ai.prompt_execution_settings.azure_chat_prompt_execution_settings import ( AzureChatPromptExecutionSettings, ) from semantic_kernel.functions import kernel_function from typing import List from semantic_kernel.contents import ChatMessageContent, TextContent, ImageContent from semantic_kernel.contents.utils.author_role import AuthorRole åˆå§‹åŒ–kernel # Initialize the kernel kernel = Kernel() æ·»åŠ LLMæœåŠ¡ # Add the Azure OpenAI chat completion service kernel.add_service(OpenAIChatCompletion( ai_model_id=\"gpt-3.5-turbo-1106\", api_key=os.getenv(\"OPENAI_API_KEY\") )) è®¾ç½®ä¼ä¸šæœåŠ¡ # Set the logging level for semantic_kernel.kernel to DEBUG. logging.basicConfig( format=\"[%(asctime)s - %(name)s:%(lineno)d - %(levelname)s] %(message)s\", datefmt=\"%Y-%m-%d %H:%M:%S\", ) logging.getLogger(\"kernel\").setLevel(logging.DEBUG) å¯åŠ¨è‡ªåŠ¨è§„åˆ’ # Enable planning execution_settings = AzureChatPromptExecutionSettings(tool_choice=\"auto\") execution_settings.function_call_behavior = FunctionCallBehavior.EnableFunctions(auto_invoke=True, filters={}) è‡ªåŠ¨è§„åˆ’å¾ªç¯\nå¦‚æœä¸ä½¿ç”¨è¯­ä¹‰å†…æ ¸çš„å‡½æ•°è°ƒç”¨ä¼šç›¸å¯¹å¤æ‚ã€‚æ‚¨éœ€è¦ç¼–å†™ä¸€ä¸ªå¾ªç¯æ¥å®Œæˆä»¥ä¸‹æ“ä½œï¼š\nä¸ºæ¯ä¸ªå‡½æ•°åˆ›å»º JSON æ¶æ„ å‘ LLM æä¾›ä¹‹å‰çš„èŠå¤©è®°å½•å’ŒåŠŸèƒ½æ¨¡å¼ è§£æ LLM çš„å“åº”ä»¥ç¡®å®šå®ƒæ˜¯è¦å›å¤æ¶ˆæ¯è¿˜æ˜¯è°ƒç”¨å‡½æ•° å¦‚æœ LLM æƒ³è¦è°ƒç”¨æŸä¸ªå‡½æ•°ï¼Œä½ éœ€è¦ä» LLM çš„å“åº”ä¸­è§£æå‡½æ•°åç§°å’Œå‚æ•° ä½¿ç”¨æ­£ç¡®çš„å‚æ•°è°ƒç”¨å‡½æ•° è¿”å›å‡½æ•°çš„ç»“æœï¼Œä»¥ä¾¿ LLM å¯ä»¥ç¡®å®šä¸‹ä¸€æ­¥è¯¥åšä»€ä¹ˆ é‡å¤æ­¥éª¤ 2-6ï¼Œç›´åˆ° LLM å†³å®šå·²å®Œæˆä»»åŠ¡æˆ–éœ€è¦ç”¨æˆ·çš„å¸®åŠ© å‡½æ•°è°ƒç”¨çš„è¿‡ç¨‹ï¼š\n1 åºåˆ—åŒ–å‡½æ•° å†…æ ¸ä¸­æ‰€æœ‰å¯ç”¨çš„å‡½æ•°ï¼ˆåŠå…¶è¾“å…¥å‚æ•°ï¼‰éƒ½ä½¿ç”¨ JSON æ¨¡å¼åºåˆ—åŒ–ã€‚ 2 å°†æ¶ˆæ¯å’Œå‡½æ•°å‘é€ç»™æ¨¡å‹ åºåˆ—åŒ–çš„å‡½æ•°ï¼ˆå’Œå½“å‰èŠå¤©è®°å½•ï¼‰ä½œä¸ºè¾“å…¥çš„ä¸€éƒ¨åˆ†å‘é€åˆ°æ¨¡å‹ã€‚ 3 æ¨¡å‹å¤„ç†è¾“å…¥ æ¨¡å‹å¤„ç†è¾“å…¥å¹¶ç”Ÿæˆå“åº”ã€‚å“åº”å¯ä»¥æ˜¯èŠå¤©æ¶ˆæ¯æˆ–å‡½æ•°è°ƒç”¨ 4 å¤„ç†å“åº” å¦‚æœå“åº”æ˜¯èŠå¤©æ¶ˆæ¯ï¼Œåˆ™è¿”å›ç»™å¼€å‘äººå‘˜ä»¥å°†å“åº”æ‰“å°åˆ°å±å¹•ä¸Šã€‚ä½†æ˜¯ï¼Œå¦‚æœå“åº”æ˜¯å‡½æ•°è°ƒç”¨ï¼Œåˆ™ Semantic Kernel ä¼šæå–å‡½æ•°åç§°åŠå…¶å‚æ•°ã€‚ 5 è°ƒç”¨å‡½æ•° æå–çš„å‡½æ•°åå’Œå‚æ•°ç”¨äºè°ƒç”¨å†…æ ¸ä¸­çš„å‡½æ•°ã€‚ 6 è¿”å›å‡½æ•°ç»“æœ ç„¶åï¼Œå‡½æ•°çš„ç»“æœå°†ä½œä¸ºèŠå¤©å†å²è®°å½•çš„ä¸€éƒ¨åˆ†å‘é€å›æ¨¡å‹ã€‚ç„¶åé‡å¤æ­¥éª¤ 2-6ï¼Œç›´åˆ°æ¨¡å‹å‘é€ç»ˆæ­¢ä¿¡å· åœ¨ Semantic Kernel ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ä¸ºæ‚¨è‡ªåŠ¨æ‰§è¡Œæ­¤å¾ªç¯ï¼Œè®©æ‚¨å¯ä»¥è½»æ¾ä½¿ç”¨å‡½æ•°è°ƒç”¨ã€‚è¿™æ ·æ‚¨å°±å¯ä»¥ä¸“æ³¨äºæ„å»ºæ»¡è¶³ç”¨æˆ·éœ€æ±‚æ‰€éœ€çš„æ’ä»¶ã€‚ è¦åœ¨è¯­ä¹‰å†…æ ¸ä¸­ä½¿ç”¨è‡ªåŠ¨å‡½æ•°è°ƒç”¨ï¼Œæ‚¨éœ€è¦æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š\nå‘å†…æ ¸æ³¨å†Œæ’ä»¶ åˆ›å»ºä¸€ä¸ªæ‰§è¡Œè®¾ç½®å¯¹è±¡ï¼Œå‘Šè¯‰ AI è‡ªåŠ¨è°ƒç”¨å‡½æ•° ä½¿ç”¨èŠå¤©å†å²è®°å½•å’Œå†…æ ¸è°ƒç”¨èŠå¤©å®ŒæˆæœåŠ¡ æ·»åŠ æ’ä»¶æœåŠ¡ï¼ˆFunction Callingï¼‰ 1.æ·»åŠ åŸç”Ÿï¼ˆNativeï¼‰ä»£ç ä½œä¸ºæ’ä»¶\nclass EmailPlugin: def __init__(self, name): self.name = name self.time = '2024-7' @kernel_function( name=\"send_email\", description=\"Sends an email to a recipient.\" ) async def send_email(self, recipient_emails: str|List[str], subject: str, body: str): # Add logic to send an email using the recipient_emails, subject, and body # For now, we'll just print out a success message to the console print(self.name + \"Email sent!\") ## ...å¯ä»¥å¤šä¸ªå‡½æ•° # Add a plugin (the EmailPlugin class is defined above) kernel.add_plugin( EmailPlugin('aliga'), plugin_name=\"Email\", ) ä¸Šè¿°æ’ä»¶åºåˆ—åŒ–å‡½æ•°åçš„JOSNå¦‚ä¸‹ï¼š\n[ { \"type\": \"function\", \"function\": { \"name\": \"send_email\", \"description\": \"Sends an email to a recipient.\", \"parameters\": { \"type\": \"object\", \"properties\": { \"recipient_emails\": { \"type\": \"string\" }, \"subject\": { \"type\": \"string\", \"enum\": [\"è¯·å‡\", \"å·¥ä½œæ–‡ä»¶\", \"æŠ¥è¡¨\"] }, \"body\": { \"type\": \"string\" } }, \"required\": [\"recipient_emails\", \"subject\", \"body\"] } } } ] 2.æ·»åŠ é€»è¾‘åº”ç”¨ä½œä¸ºæ’ä»¶ï¼ˆä»…é™C#ï¼‰\nå»ºç«‹å¯¹è¯æœåŠ¡ï¼ˆç¡®å®šä¸Šè¿°æœåŠ¡åï¼‰ # Build the kernel and retrieve services chat_completion : AzureChatCompletion = kernel.get_service(type=ChatCompletionClientBase) åˆ›å»ºå†å²å¯¹è¯ï¼Œå¹¶è®¾ç½®prompt æ–¹æ³•ä¸€\n# Create a history of the conversation history = ChatHistory(system_message=\"\"\" You are a friendly assistant who likes to follow the rules. You will complete required steps and request approval before taking any consequential actions. If the user doesn't provide enough information for you to complete a task, you will keep asking questions until you have enough information to complete the task. \"\"\") æ–¹æ³•äºŒ\n# æ·»åŠ system_messageç¬¬äºŒç§æ–¹æ³• chat_history = ChatHistory() chat_history.add_system_message(\"You are a helpful assistant.\") æ–¹æ³•ä¸‰\n# Add system messageï¼Œç¬¬ä¸‰ç§æ–¹æ³• history = ChatHistory() chat_history.add_message( ChatMessage( role=AuthorRole.System, content=\"You are a helpful assistant\" ) ) æ·»åŠ ç”¨æˆ·è¾“å…¥è®°å½• æ–¹æ³•ä¸€ï¼šæ–‡æœ¬\nhistory.add_user_message(user_input) æ–¹æ³•äºŒï¼šæ–‡æœ¬\n# Add additional message from a different userï¼Œç¬¬äºŒç§æ–¹æ³•ï¼Œå¯ä»¥æŒ‡å®šname chat_history.add_message( ChatMessageContent( role=AuthorRole.USER, name=\"Ema Vargova\", content=\"I'd like to have the first option, please.\" ) ) æ–¹æ³•ä¸‰ï¼šæ·»åŠ å›¾ç‰‡\n# Add user message with an image chat_history.add_message( ChatMessageContent( role=AuthorRole.USER, name=\"Laimonis Dumins\", items=[ TextContent(text=\"What available on this menu\"), ImageContent(uri=\"https://example.com/menu.jpg\") ] ) ) æ‰§è¡Œå¯¹è¯ï¼Œè·å¾—å›å¤ # Get the response from the AI result = (await chat_completion.get_chat_message_contents( chat_history=history, settings=execution_settings, kernel=kernel, arguments=KernelArguments(), ))[0] # Print the response print(\"Assistant \u003e \" + str(result)) æ·»åŠ AIå“åº”è®°å½• æ–¹æ³•ä¸€\nhistory.add_assistant_message(str(result)) æ–¹æ³•äºŒ\n# Add assistant messageï¼Œç¬¬äºŒç§æ–¹æ³•ï¼Œå¯ä»¥æŒ‡å®šname chat_history.add_message( ChatMessageContent( role=AuthorRole.ASSISTANT, name=\"Restaurant Assistant\", content=\"We have pizza, pasta, and salad available to order. What would you like to order?\" ) ) ä½¿ç”¨SKå®ç°RAG å‚è€ƒï¼šhttps://github.com/john0isaac/rag-semantic-kernel-mongodb-vcore/blob/main/rag-azure-openai-cosmosdb-notebook.ipynb è®¾ç½®ä¸€äº›å‚æ•°\n# collection name will be used multiple times in the code so we store it in a variable collection_name = 'VectorSearchCollection' # Vector search index parameters index_name = \"VectorSearchIndex\" vector_dimensions = 1536 # text-embedding-ada-002 uses a 1536-dimensional embedding vector num_lists = 1 similarity = \"COS\" # cosine distance é…ç½®LLMChatã€embeddingæ¨¡å‹\n1.Azure\nfrom semantic_kernel import Kernel import os from dotenv import load_dotenv, find_dotenv from semantic_kernel.connectors.ai.open_ai import ( AzureChatCompletion, AzureTextEmbedding, ) # Intialize the kernel kernel = Kernel() # adding azure openai chat service chat_model_deployment_name = os.environ.get(\"AZURE_OPENAI_CHAT_DEPLOYMENT_NAME\") endpoint = os.environ.get(\"AZURE_OPENAI_ENDPOINT\") api_key = os.environ.get(\"AZURE_OPENAI_API_KEY\") kernel.add_service( AzureChatCompletion( service_id=\"chat_completion\", deployment_name=chat_model_deployment_name, endpoint=endpoint, api_key=api_key, # adding azure openai text embedding service embedding_model_deployment_name = os.environ.get(\"AZURE_OPENAI_EMBEDDINGS_DEPLOYMENT_NAME\") kernel.add_service( AzureTextEmbedding( service_id=\"text_embedding\", deployment_name=embedding_model_deployment_name, endpoint=endpoint, api_key=api_key, ) ) 2.openai\nfrom semantic_kernel import Kernel import os from dotenv import load_dotenv, find_dotenv from semantic_kernel.connectors.ai.open_ai import ( AzureChatCompletion, AzureTextEmbedding, OpenAIChatCompletion, OpenAITextEmbeddingï¼Œ ) # Intialize the kernel kernel = Kernel() openai_api_key = os.getenv(\"OPENAI_API_KEY\") # Add the OpenAI service kernel.add_service(OpenAIChatCompletion( ai_model_id=\"gpt-4o-mini-2024-07-18\", api_key=os.getenv(\"OPENAI_API_KEY\") )) kernel.add_service( embedding_gen = OpenAITextEmbedding( ai_model_id=\"text-embedding-3-small\", api_key = openai_api_key ) ) é…ç½®å‘é‡æ•°æ®åº“ semantic kernelçš„APIä¸­çš„æ”¯æŒæœ¬åœ°æ•°æ®åº“ï¼Œäº‘æ•°æ®åº“å¸¸ç”¨Azureè¾ƒå¤šã€‚ æ³¨æ„ï¼šæš‚ä¸æ”¯æŒpineconeäº‘æ•°æ®åº“ã€‚\nfrom semantic_kernel.connectors.memory.azure_cosmosdb import ( AzureCosmosDBMemoryStore, ) print(\"Creating or updating Azure Cosmos DB Memory Store...\") # create azure cosmos db for mongo db vcore api store and collection with vector ivf # currently, semantic kernel only supports the ivf vector kind store = await AzureCosmosDBMemoryStore.create( cosmos_connstr=os.environ.get(\"AZCOSMOS_CONNSTR\"), cosmos_api=\"mongo-vcore\", database_name=os.environ.get(\"AZCOSMOS_DATABASE_NAME\"), collection_name=collection_name, index_name=index_name, vector_dimensions=vector_dimensions, num_lists=num_lists, similarity=similarity, ) print(\"Finished updating Azure Cosmos DB Memory Store...\") from semantic_kernel.memory.semantic_text_memory import SemanticTextMemory from semantic_kernel.core_plugins.text_memory_plugin import TextMemoryPlugin memory = SemanticTextMemory(storage=store, embeddings_generator=kernel.get_service(\"text_embedding\")) kernel.add_plugin(TextMemoryPlugin(memory), \"TextMemoryPluginACDB\") print(\"Registered Azure Cosmos DB Memory Store...\") ç”ŸæˆåµŒå…¥å¹¶åˆ›å»ºæ•°æ®åº“è®°å½•\nimport json from semantic_kernel.memory.semantic_text_memory import SemanticTextMemory from semantic_kernel.memory.memory_store_base import MemoryStoreBase async def upsert_data_to_memory_store(memory: SemanticTextMemory, store: MemoryStoreBase, data_file_path: str) -\u003e None: \"\"\" This asynchronous function takes two memory stores and a data file path as arguments. It is designed to upsert (update or insert) data into the memory stores from the data file. Args: memory (callable): A callable object that represents the semantic kernel memory. store (callable): A callable object that represents the memory store where data will be upserted. data_file_path (str): The path to the data file that contains the data to be upserted. Returns: None. The function performs an operation that modifies the memory stores in-place. \"\"\" with open(file=data_file_path, mode=\"r\", encoding=\"utf-8\") as f: data = json.load(f) n = 0 for item in data: n += 1 # check if the item already exists in the memory store # if the id doesn't exist, it throws an exception try: already_created = bool(await store.get(collection_name, item[\"id\"], with_embedding=True)) except Exception: already_created = False # if the record doesn't exist, we generate embeddings and save it to the database if not already_created: await memory.save_information( collection=collection_name, id=item[\"id\"], # the embedding is generated from the text field text=item[\"content\"], description=item[\"title\"], ) print( \"Generating embeddings and saving new item:\", n, \"/\", len(data), end=\"\\r\", ) else: print(\"Skipping item already exits:\", n, \"/\", len(data), end=\"\\r\") # cleaned-top-movies-chunked.json contains the top 344 movie from the IMDB movies dataset # You can also try the text-sample.json which contains 107 Azure Service. # Replace the file name cleaned-top-movies-chunked.json with text-sample.json #ç”ŸæˆåµŒå…¥å¹¶åˆ›å»ºæ•°æ®åº“è®°å½• print(\"Upserting data to Azure Cosmos DB Memory Store...\") await upsert_data_to_memory_store(memory, store, \"./src/data/cleaned-top-movies-chunked.json\") ï¼ˆå¯é€‰ï¼‰æµ‹è¯•å‘é‡æ•°æ®åº“\n# each time it calls the embedding model to generate embeddings from your query query_term = \"What do you know about the godfather?\" result = await memory.search(collection_name, query_term) print( f\"Result is: {result[0].text}\\nRelevance Score: {result[0].relevance}\\nFull Record: {result[0].additional_metadata}\" ) RAG flow\n# 1.è®¾ç½®prompt prompt = \"\"\" Give explicit answers from the provided context or say 'I don't know' if it does not have an answer. provided context: {{$db_record}} User: {{$query_term}} Chatbot:\"\"\" from semantic_kernel.connectors.ai.open_ai import OpenAITextPromptExecutionSettings # 2.æŒ‡å®škernelä¸­çš„LLMï¼Œå¹¶è®¾ç½®å‚æ•° execution_settings = OpenAITextPromptExecutionSettings( service_id=\"chat_completion\", ai_model_id=chat_model_deployment_name, max_tokens=500, temperature=0.0, top_p=0.5 ) from semantic_kernel.prompt_template import PromptTemplateConfig from semantic_kernel.prompt_template.input_variable import InputVariable # 3.é…ç½®chatåŠŸèƒ½ chat_prompt_hist_template_config = PromptTemplateConfig( template=prompt, name=\"grounded_response_history\", template_format=\"semantic-kernel\", input_variables=[ InputVariable(name=\"db_record\", description=\"The database record\", is_required=True), InputVariable(name=\"query_term\", description=\"The user input\", is_required=True), InputVariable(name=\"history\", description=\"The chat histroy\", is_required=True), ], execution_settings=execution_settings, ) chat_history_function = kernel.add_function( function_name=\"ChatGPTFuncHist\", plugin_name=\"chatGPTPluginHist\", prompt_template_config=chat_prompt_hist_template_config ) # 4.è°ƒç”¨ from semantic_kernel.functions import KernelArguments from semantic_kernel.contents import ChatHistory import time chat_history = ChatHistory() chat_history.add_system_message(\"You are a helpful chatbot who is good about giving movie recommendations.\") query_term = \"\" search_result = \"\" completions_result = \"\" while query_term != \"exit\": query_term = input(\"Enter a query: \") chat_history.add_user_message(query_term) search_result = await memory.search(collection_name, query_term) # vector search completions_result = await kernel.invoke( chat_history_function, KernelArguments(query_term=query_term, db_record=search_result[0].additional_metadata) ) chat_history.add_assistant_message(str(completions_result)) print(f\"Question:\\n{query_term}\\nResponse:\") print(str(completions_result), end=\"\") print(\"\\n\") time.sleep(5) ",
  "wordCount" : "2528",
  "inLanguage": "zh",
  "datePublished": "2024-07-28T00:18:23+08:00",
  "dateModified": "2024-07-28T00:18:23+08:00",
  "author":[{
    "@type": "Person",
    "name": "aliga"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://Aliga123.github.io/posts/ai-llm/semantic-kernel/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "aliga's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://Aliga123.github.io/img/Q.gif"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    (function () {
        let  arr,reg = new RegExp("(^| )"+"change-themes"+"=([^;]*)(;|$)");
        if(arr = document.cookie.match(reg)) {
        } else {
            if (new Date().getHours() >= 19 || new Date().getHours() < 6) {
                document.body.classList.add('dark');
                localStorage.setItem("pref-theme", 'dark');
            } else {
                document.body.classList.remove('dark');
                localStorage.setItem("pref-theme", 'light');
            }
        }
    })()

    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }
</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://Aliga123.github.io/" accesskey="h" title="Aliga&#39;s Blog (Alt + H)">
            <img src="https://Aliga123.github.io/img/Q.gif" alt="logo" aria-label="logo"
                 height="35">Aliga&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                </ul>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://Aliga123.github.io/search" title="ğŸ” æœç´¢ (Alt &#43; /)" accesskey=/>
                <span>ğŸ” æœç´¢</span>
                </a>
            </li>
            <li>
                <a href="https://Aliga123.github.io/" title="ğŸ  ä¸»é¡µ">
                <span>ğŸ  ä¸»é¡µ</span>
                </a>
            </li>
            <li>
                <a href="https://Aliga123.github.io/posts" title="ğŸ“š æ–‡ç« ">
                <span>ğŸ“š æ–‡ç« </span>
                </a>
            </li>
            <li>
                <a href="https://Aliga123.github.io/tags" title="ğŸ§© æ ‡ç­¾">
                <span>ğŸ§© æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="https://Aliga123.github.io/archives/" title="â±ï¸ æ—¶é—´è½´">
                <span>â±ï¸ æ—¶é—´è½´</span>
                </a>
            </li>
            <li>
                <a href="https://Aliga123.github.io/about" title="ğŸ™‹ğŸ»â€â™‚ï¸ å…³äº">
                <span>ğŸ™‹ğŸ»â€â™‚ï¸ å…³äº</span>
                </a>
            </li>
            <li>
                <a href="https://Aliga123.github.io/links" title="ğŸ¤ å‹é“¾">
                <span>ğŸ¤ å‹é“¾</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main page">
<style>
    i[id*="post_meta_style"] {
        display: flex;
        align-items: center;
        margin: 0 0 10px 0;
    }
</style>

<article class="post-single">
    <div id="single-content">
        <header class="post-header">
            <div class="breadcrumbs"><a href="https://Aliga123.github.io/">ğŸ  ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://Aliga123.github.io/posts/">ğŸ“šæ–‡ç« </a>&nbsp;Â»&nbsp;<a href="https://Aliga123.github.io/posts/ai-llm/">ğŸ§± AIå¤§æ¨¡å‹åº”ç”¨å¼€å‘</a></div>
            <h1 class="post-title">
                Semantic Kernel
            </h1>
            <div class="post-meta">

<style>
    i[id*="post_meta_style"] {
        display: flex;
        align-items: center;
        margin: 0 0 10px 0;
    }

    .parent-post-meta {
        display: flex;
        flex-wrap: wrap;
        opacity: 0.8;
    }
</style>

<span class="parent-post-meta">
    <span id="post_meta_style_1">
        <span class="fa fa-calendar-check-o"></span>
        <span>2024-07-28
            &nbsp;&nbsp;
        </span>
    </span>
    
    
    
    
    
    
    
    <span id="post_meta_style_3">
        <span class="fa fa-file-word-o"></span>
        <span>2528å­—
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_4">
        <span class="fa fa-clock-o"></span>
        <span>6åˆ†é’Ÿ
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_5">
        <span class="fa fa-user-o"></span>
        <span>aliga
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_6">
        <span class="fa fa-tags" style="opacity: 0.8"></span>
        <span>
            <span class="post-tags-meta">
            </span>
        </span>
    </span>
</span>
<span style="opacity: 0.8;">
                    <span id="post_meta_style_7">
                        &nbsp;&nbsp;
                        <span class="fa fa-eye" ></span>
                        <span>
                            <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv"></span></span>
                            &nbsp;&nbsp;
                        </span>
                    </span>
                    <span id="post_meta_style_8">
                        <span class="fa fa-commenting-o"></span>
                        <span>
                            <script src="https://cdn.staticfile.org/twikoo/1.5.8/twikoo.all.min.js"></script>
                            <script>
                                let url = document.documentURI
                                
                                let dnsUrl = "https://Aliga123.github.io/"
                                let urlSplit = url.split(dnsUrl)
                                let finalUrl = urlSplit[1]
                                if (finalUrl[0] !== '/') {
                                    finalUrl = '/'+finalUrl
                                }
                                twikoo.getCommentsCount({
                                    envId:  null , 
                                region:  null , 
                                urls: [ 
                                    
                                    finalUrl,
                                ],
                                    includeReply: false 
                                }).then(function (res) {
                                    let count = res[0].count
                                    const obj = document.getElementById("comment_count");
                                    obj.innerText = count
                                    
                                    
                                    
                                }).catch(function (err) {
                                    
                                    console.error(err);
                                });
                            </script>
                            <span id="comment_count"></span>
                        </span>
                    </span>
                </span>

</div>
        </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">ç›®å½•</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#semantic-kernel" aria-label="Semantic Kernel">Semantic Kernel</a><ul>
                        
                <li>
                    <a href="#%e5%af%bc%e5%85%a5%e5%b8%b8%e7%94%a8%e7%9a%84%e5%ba%93" aria-label="å¯¼å…¥å¸¸ç”¨çš„åº“">å¯¼å…¥å¸¸ç”¨çš„åº“</a></li>
                <li>
                    <a href="#%e5%88%9d%e5%a7%8b%e5%8c%96kernel" aria-label="åˆå§‹åŒ–kernel">åˆå§‹åŒ–kernel</a></li>
                <li>
                    <a href="#%e6%b7%bb%e5%8a%a0llm%e6%9c%8d%e5%8a%a1" aria-label="æ·»åŠ LLMæœåŠ¡">æ·»åŠ LLMæœåŠ¡</a></li>
                <li>
                    <a href="#%e8%ae%be%e7%bd%ae%e4%bc%81%e4%b8%9a%e6%9c%8d%e5%8a%a1" aria-label="è®¾ç½®ä¼ä¸šæœåŠ¡">è®¾ç½®ä¼ä¸šæœåŠ¡</a></li>
                <li>
                    <a href="#%e5%90%af%e5%8a%a8%e8%87%aa%e5%8a%a8%e8%a7%84%e5%88%92" aria-label="å¯åŠ¨è‡ªåŠ¨è§„åˆ’">å¯åŠ¨è‡ªåŠ¨è§„åˆ’</a></li>
                <li>
                    <a href="#%e6%b7%bb%e5%8a%a0%e6%8f%92%e4%bb%b6%e6%9c%8d%e5%8a%a1function-calling" aria-label="æ·»åŠ æ’ä»¶æœåŠ¡ï¼ˆFunction Callingï¼‰">æ·»åŠ æ’ä»¶æœåŠ¡ï¼ˆFunction Callingï¼‰</a></li>
                <li>
                    <a href="#%e5%bb%ba%e7%ab%8b%e5%af%b9%e8%af%9d%e6%9c%8d%e5%8a%a1%e7%a1%ae%e5%ae%9a%e4%b8%8a%e8%bf%b0%e6%9c%8d%e5%8a%a1%e5%90%8e" aria-label="å»ºç«‹å¯¹è¯æœåŠ¡ï¼ˆç¡®å®šä¸Šè¿°æœåŠ¡åï¼‰">å»ºç«‹å¯¹è¯æœåŠ¡ï¼ˆç¡®å®šä¸Šè¿°æœåŠ¡åï¼‰</a></li>
                <li>
                    <a href="#%e5%88%9b%e5%bb%ba%e5%8e%86%e5%8f%b2%e5%af%b9%e8%af%9d%e5%b9%b6%e8%ae%be%e7%bd%aeprompt" aria-label="åˆ›å»ºå†å²å¯¹è¯ï¼Œå¹¶è®¾ç½®prompt">åˆ›å»ºå†å²å¯¹è¯ï¼Œå¹¶è®¾ç½®prompt</a></li>
                <li>
                    <a href="#%e6%b7%bb%e5%8a%a0%e7%94%a8%e6%88%b7%e8%be%93%e5%85%a5%e8%ae%b0%e5%bd%95" aria-label="æ·»åŠ ç”¨æˆ·è¾“å…¥è®°å½•">æ·»åŠ ç”¨æˆ·è¾“å…¥è®°å½•</a></li>
                <li>
                    <a href="#%e6%89%a7%e8%a1%8c%e5%af%b9%e8%af%9d%e8%8e%b7%e5%be%97%e5%9b%9e%e5%a4%8d" aria-label="æ‰§è¡Œå¯¹è¯ï¼Œè·å¾—å›å¤">æ‰§è¡Œå¯¹è¯ï¼Œè·å¾—å›å¤</a></li>
                <li>
                    <a href="#%e6%b7%bb%e5%8a%a0ai%e5%93%8d%e5%ba%94%e8%ae%b0%e5%bd%95" aria-label="æ·»åŠ AIå“åº”è®°å½•">æ·»åŠ AIå“åº”è®°å½•</a></li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8sk%e5%ae%9e%e7%8e%b0rag" aria-label="ä½¿ç”¨SKå®ç°RAG">ä½¿ç”¨SKå®ç°RAG</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        
        activeElement = elements[0];
        const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
        document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
    }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        if (elements) {
            activeElement = Array.from(elements).find((element) => {
                if ((getOffsetTop(element) - window.pageYOffset) > 0 &&
                    (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                    return element;
                }
            }) || activeElement

            elements.forEach(element => {
                const id = encodeURI(element.getAttribute('id')).toLowerCase();
                if (element === activeElement){
                    document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
                } else {
                    document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
                }
            })
        }
    }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;
        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;
    }
</script>
        <div class="post-content"><h1 id="semantic-kernel">Semantic Kernel<a hidden class="anchor" aria-hidden="true" href="#semantic-kernel">#</a></h1>
<p>Sematic Kernel é€šè¿‡ <strong>Kernel</strong> é“¾æ¥ LLM ä¸ <strong>Functions</strong>ï¼ˆåŠŸèƒ½ï¼‰:</p>
<ul>
<li>Semantic Functionsï¼šé€šè¿‡ Prompt å®ç°çš„ LLM èƒ½åŠ›</li>
<li>Native Functions: ç¼–ç¨‹è¯­è¨€åŸç”Ÿçš„å‡½æ•°åŠŸèƒ½</li>
</ul>
<p>åœ¨ SK ä¸­ï¼Œä¸€ç»„ Function ç»„æˆä¸€ä¸ªæŠ€èƒ½ï¼ˆSkill/Pluginï¼‰ã€‚è¦è¿è¡Œ Skill/Pluginï¼Œéœ€è¦æœ‰ä¸€ä¸ªé…ç½®å’Œç®¡ç†çš„å•å…ƒï¼Œè¿™ä¸ªç»„ç»‡ç®¡ç†å•å…ƒå°±æ˜¯ Kernelã€‚</p>
<p>Kernel è´Ÿè´£ç®¡ç†åº•å±‚æ¥å£ä¸è°ƒç”¨é¡ºåºï¼Œä¾‹å¦‚ï¼šOpenAI/Azure OpenAI çš„æˆæƒä¿¡æ¯ã€é»˜è®¤çš„ LLM æ¨¡å‹é€‰æ‹©ã€å¯¹è¯ä¸Šä¸‹æ–‡ã€æŠ€èƒ½å‚æ•°çš„ä¼ é€’ç­‰ç­‰ã€‚</p>
<h2 id="å¯¼å…¥å¸¸ç”¨çš„åº“">å¯¼å…¥å¸¸ç”¨çš„åº“<a hidden class="anchor" aria-hidden="true" href="#å¯¼å…¥å¸¸ç”¨çš„åº“">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> dotenv <span style="color:#f92672">import</span> load_dotenv, find_dotenv
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> logging
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> semantic_kernel <span style="color:#f92672">import</span> Kernel
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> semantic_kernel.functions <span style="color:#f92672">import</span> kernel_function
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> semantic_kernel.connectors.ai.open_ai <span style="color:#f92672">import</span> AzureChatCompletion
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> semantic_kernel.connectors.ai.open_ai <span style="color:#f92672">import</span> OpenAIChatCompletion
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> semantic_kernel.connectors.ai.function_call_behavior <span style="color:#f92672">import</span> FunctionCallBehavior
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> semantic_kernel.connectors.ai.chat_completion_client_base <span style="color:#f92672">import</span> ChatCompletionClientBase
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> semantic_kernel.contents.chat_history <span style="color:#f92672">import</span> ChatHistory
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> semantic_kernel.functions.kernel_arguments <span style="color:#f92672">import</span> KernelArguments
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> semantic_kernel.connectors.ai.open_ai.prompt_execution_settings.azure_chat_prompt_execution_settings <span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>    AzureChatPromptExecutionSettings,
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> semantic_kernel.functions <span style="color:#f92672">import</span> kernel_function
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> List
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> semantic_kernel.contents <span style="color:#f92672">import</span> ChatMessageContent, TextContent, ImageContent
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> semantic_kernel.contents.utils.author_role <span style="color:#f92672">import</span> AuthorRole
</span></span></code></pre></div><h2 id="åˆå§‹åŒ–kernel">åˆå§‹åŒ–kernel<a hidden class="anchor" aria-hidden="true" href="#åˆå§‹åŒ–kernel">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Initialize the kernel</span>
</span></span><span style="display:flex;"><span>kernel <span style="color:#f92672">=</span> Kernel()
</span></span></code></pre></div><h2 id="æ·»åŠ llmæœåŠ¡">æ·»åŠ LLMæœåŠ¡<a hidden class="anchor" aria-hidden="true" href="#æ·»åŠ llmæœåŠ¡">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Add the Azure OpenAI chat completion service</span>
</span></span><span style="display:flex;"><span>kernel<span style="color:#f92672">.</span>add_service(OpenAIChatCompletion(
</span></span><span style="display:flex;"><span>    ai_model_id<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;gpt-3.5-turbo-1106&#34;</span>,
</span></span><span style="display:flex;"><span>    api_key<span style="color:#f92672">=</span>os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#34;OPENAI_API_KEY&#34;</span>)
</span></span><span style="display:flex;"><span>))
</span></span></code></pre></div><h2 id="è®¾ç½®ä¼ä¸šæœåŠ¡">è®¾ç½®ä¼ä¸šæœåŠ¡<a hidden class="anchor" aria-hidden="true" href="#è®¾ç½®ä¼ä¸šæœåŠ¡">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Set the logging level for  semantic_kernel.kernel to DEBUG.</span>
</span></span><span style="display:flex;"><span>logging<span style="color:#f92672">.</span>basicConfig(
</span></span><span style="display:flex;"><span>    format<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;[</span><span style="color:#e6db74">%(asctime)s</span><span style="color:#e6db74"> - </span><span style="color:#e6db74">%(name)s</span><span style="color:#e6db74">:</span><span style="color:#e6db74">%(lineno)d</span><span style="color:#e6db74"> - </span><span style="color:#e6db74">%(levelname)s</span><span style="color:#e6db74">] </span><span style="color:#e6db74">%(message)s</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>    datefmt<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;%Y-%m-</span><span style="color:#e6db74">%d</span><span style="color:#e6db74"> %H:%M:%S&#34;</span>,
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>logging<span style="color:#f92672">.</span>getLogger(<span style="color:#e6db74">&#34;kernel&#34;</span>)<span style="color:#f92672">.</span>setLevel(logging<span style="color:#f92672">.</span>DEBUG)
</span></span></code></pre></div><h2 id="å¯åŠ¨è‡ªåŠ¨è§„åˆ’">å¯åŠ¨è‡ªåŠ¨è§„åˆ’<a hidden class="anchor" aria-hidden="true" href="#å¯åŠ¨è‡ªåŠ¨è§„åˆ’">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Enable planning</span>
</span></span><span style="display:flex;"><span>execution_settings <span style="color:#f92672">=</span> AzureChatPromptExecutionSettings(tool_choice<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;auto&#34;</span>)
</span></span><span style="display:flex;"><span>execution_settings<span style="color:#f92672">.</span>function_call_behavior <span style="color:#f92672">=</span> FunctionCallBehavior<span style="color:#f92672">.</span>EnableFunctions(auto_invoke<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, filters<span style="color:#f92672">=</span>{})
</span></span></code></pre></div><p><strong>è‡ªåŠ¨è§„åˆ’å¾ªç¯</strong></p>
<p>å¦‚æœä¸ä½¿ç”¨è¯­ä¹‰å†…æ ¸çš„å‡½æ•°è°ƒç”¨ä¼šç›¸å¯¹å¤æ‚ã€‚æ‚¨éœ€è¦ç¼–å†™ä¸€ä¸ªå¾ªç¯æ¥å®Œæˆä»¥ä¸‹æ“ä½œï¼š</p>
<ol>
<li>ä¸ºæ¯ä¸ªå‡½æ•°åˆ›å»º JSON æ¶æ„</li>
<li>å‘ LLM æä¾›ä¹‹å‰çš„èŠå¤©è®°å½•å’ŒåŠŸèƒ½æ¨¡å¼</li>
<li>è§£æ LLM çš„å“åº”ä»¥ç¡®å®šå®ƒæ˜¯è¦å›å¤æ¶ˆæ¯è¿˜æ˜¯è°ƒç”¨å‡½æ•°</li>
<li>å¦‚æœ LLM æƒ³è¦è°ƒç”¨æŸä¸ªå‡½æ•°ï¼Œä½ éœ€è¦ä» LLM çš„å“åº”ä¸­è§£æå‡½æ•°åç§°å’Œå‚æ•°</li>
<li>ä½¿ç”¨æ­£ç¡®çš„å‚æ•°è°ƒç”¨å‡½æ•°</li>
<li>è¿”å›å‡½æ•°çš„ç»“æœï¼Œä»¥ä¾¿ LLM å¯ä»¥ç¡®å®šä¸‹ä¸€æ­¥è¯¥åšä»€ä¹ˆ</li>
<li>é‡å¤æ­¥éª¤ 2-6ï¼Œç›´åˆ° LLM å†³å®šå·²å®Œæˆä»»åŠ¡æˆ–éœ€è¦ç”¨æˆ·çš„å¸®åŠ©</li>
</ol>
<p>å‡½æ•°è°ƒç”¨çš„è¿‡ç¨‹ï¼š</p>
<p><img loading="lazy" src="https://learn.microsoft.com/en-us/semantic-kernel/media/functioncalling.png" alt="è¯­ä¹‰å†…æ ¸å‡½æ•°è°ƒç”¨"  />
</p>
<table>
<thead>
<tr>
<th>1</th>
<th><a href="https://learn.microsoft.com/en-us/semantic-kernel/concepts/ai-services/chat-completion/function-calling?pivots=programming-language-python#1-serializing-the-functions"><strong>åºåˆ—åŒ–å‡½æ•°</strong></a></th>
<th>å†…æ ¸ä¸­æ‰€æœ‰å¯ç”¨çš„å‡½æ•°ï¼ˆåŠå…¶è¾“å…¥å‚æ•°ï¼‰éƒ½ä½¿ç”¨ JSON æ¨¡å¼åºåˆ—åŒ–ã€‚</th>
</tr>
</thead>
<tbody>
<tr>
<td>2</td>
<td><a href="https://learn.microsoft.com/en-us/semantic-kernel/concepts/ai-services/chat-completion/function-calling?pivots=programming-language-python#2-sending-the-messages-and-functions-to-the-model"><strong>å°†æ¶ˆæ¯å’Œå‡½æ•°å‘é€ç»™æ¨¡å‹</strong></a></td>
<td>åºåˆ—åŒ–çš„å‡½æ•°ï¼ˆå’Œå½“å‰èŠå¤©è®°å½•ï¼‰ä½œä¸ºè¾“å…¥çš„ä¸€éƒ¨åˆ†å‘é€åˆ°æ¨¡å‹ã€‚</td>
</tr>
<tr>
<td>3</td>
<td><a href="https://learn.microsoft.com/en-us/semantic-kernel/concepts/ai-services/chat-completion/function-calling?pivots=programming-language-python#3-model-processes-the-input"><strong>æ¨¡å‹å¤„ç†è¾“å…¥</strong></a></td>
<td>æ¨¡å‹å¤„ç†è¾“å…¥å¹¶ç”Ÿæˆå“åº”ã€‚å“åº”å¯ä»¥æ˜¯èŠå¤©æ¶ˆæ¯æˆ–å‡½æ•°è°ƒç”¨</td>
</tr>
<tr>
<td>4</td>
<td><a href="https://learn.microsoft.com/en-us/semantic-kernel/concepts/ai-services/chat-completion/function-calling?pivots=programming-language-python#4-handle-the-response"><strong>å¤„ç†å“åº”</strong></a></td>
<td>å¦‚æœå“åº”æ˜¯èŠå¤©æ¶ˆæ¯ï¼Œåˆ™è¿”å›ç»™å¼€å‘äººå‘˜ä»¥å°†å“åº”æ‰“å°åˆ°å±å¹•ä¸Šã€‚ä½†æ˜¯ï¼Œå¦‚æœå“åº”æ˜¯å‡½æ•°è°ƒç”¨ï¼Œåˆ™ Semantic Kernel ä¼šæå–å‡½æ•°åç§°åŠå…¶å‚æ•°ã€‚</td>
</tr>
<tr>
<td>5</td>
<td><a href="https://learn.microsoft.com/en-us/semantic-kernel/concepts/ai-services/chat-completion/function-calling?pivots=programming-language-python#5-invoke-the-function"><strong>è°ƒç”¨å‡½æ•°</strong></a></td>
<td>æå–çš„å‡½æ•°åå’Œå‚æ•°ç”¨äºè°ƒç”¨å†…æ ¸ä¸­çš„å‡½æ•°ã€‚</td>
</tr>
<tr>
<td>6</td>
<td><a href="https://learn.microsoft.com/en-us/semantic-kernel/concepts/ai-services/chat-completion/function-calling?pivots=programming-language-python#6-return-the-function-result"><strong>è¿”å›å‡½æ•°ç»“æœ</strong></a></td>
<td>ç„¶åï¼Œå‡½æ•°çš„ç»“æœå°†ä½œä¸ºèŠå¤©å†å²è®°å½•çš„ä¸€éƒ¨åˆ†å‘é€å›æ¨¡å‹ã€‚ç„¶åé‡å¤æ­¥éª¤ 2-6ï¼Œç›´åˆ°æ¨¡å‹å‘é€ç»ˆæ­¢ä¿¡å·</td>
</tr>
</tbody>
</table>
<p>åœ¨ Semantic Kernel ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ä¸ºæ‚¨è‡ªåŠ¨æ‰§è¡Œæ­¤å¾ªç¯ï¼Œè®©æ‚¨å¯ä»¥è½»æ¾ä½¿ç”¨å‡½æ•°è°ƒç”¨ã€‚è¿™æ ·æ‚¨å°±å¯ä»¥ä¸“æ³¨äºæ„å»ºæ»¡è¶³ç”¨æˆ·éœ€æ±‚æ‰€éœ€çš„æ’ä»¶ã€‚
è¦åœ¨è¯­ä¹‰å†…æ ¸ä¸­ä½¿ç”¨è‡ªåŠ¨å‡½æ•°è°ƒç”¨ï¼Œæ‚¨éœ€è¦æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p>
<ol>
<li>å‘å†…æ ¸æ³¨å†Œæ’ä»¶</li>
<li>åˆ›å»ºä¸€ä¸ªæ‰§è¡Œè®¾ç½®å¯¹è±¡ï¼Œå‘Šè¯‰ AI è‡ªåŠ¨è°ƒç”¨å‡½æ•°</li>
<li>ä½¿ç”¨èŠå¤©å†å²è®°å½•å’Œå†…æ ¸è°ƒç”¨èŠå¤©å®ŒæˆæœåŠ¡</li>
</ol>
<h2 id="æ·»åŠ æ’ä»¶æœåŠ¡function-calling">æ·»åŠ æ’ä»¶æœåŠ¡ï¼ˆFunction Callingï¼‰<a hidden class="anchor" aria-hidden="true" href="#æ·»åŠ æ’ä»¶æœåŠ¡function-calling">#</a></h2>
<p><strong>1.æ·»åŠ åŸç”Ÿï¼ˆNativeï¼‰ä»£ç ä½œä¸ºæ’ä»¶</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">EmailPlugin</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self, name):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>name <span style="color:#f92672">=</span> name
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>time <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;2024-7&#39;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@kernel_function</span>(
</span></span><span style="display:flex;"><span>        name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;send_email&#34;</span>,
</span></span><span style="display:flex;"><span>        description<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Sends an email to a recipient.&#34;</span>
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">send_email</span>(self, recipient_emails: str<span style="color:#f92672">|</span>List[str], subject: str, body: str):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Add logic to send an email using the recipient_emails, subject, and body</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># For now, we&#39;ll just print out a success message to the console</span>
</span></span><span style="display:flex;"><span>        print(self<span style="color:#f92672">.</span>name <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;Email sent!&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">## ...å¯ä»¥å¤šä¸ªå‡½æ•°</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Add a plugin (the EmailPlugin class is defined above)</span>
</span></span><span style="display:flex;"><span>kernel<span style="color:#f92672">.</span>add_plugin(
</span></span><span style="display:flex;"><span>    EmailPlugin(<span style="color:#e6db74">&#39;aliga&#39;</span>),
</span></span><span style="display:flex;"><span>    plugin_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Email&#34;</span>,
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p>ä¸Šè¿°æ’ä»¶åºåˆ—åŒ–å‡½æ•°åçš„JOSNå¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>[
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;function&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;function&#34;</span>: {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;send_email&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;description&#34;</span>: <span style="color:#e6db74">&#34;Sends an email to a recipient.&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;parameters&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;object&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;properties&#34;</span>: {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;recipient_emails&#34;</span>: {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;string&#34;</span>
</span></span><span style="display:flex;"><span>          },
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;subject&#34;</span>: {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;string&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;enum&#34;</span>: [<span style="color:#e6db74">&#34;è¯·å‡&#34;</span>, <span style="color:#e6db74">&#34;å·¥ä½œæ–‡ä»¶&#34;</span>, <span style="color:#e6db74">&#34;æŠ¥è¡¨&#34;</span>]
</span></span><span style="display:flex;"><span>          },
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;body&#34;</span>: {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;string&#34;</span>
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;required&#34;</span>: [<span style="color:#e6db74">&#34;recipient_emails&#34;</span>, <span style="color:#e6db74">&#34;subject&#34;</span>, <span style="color:#e6db74">&#34;body&#34;</span>]
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><p><strong>2.æ·»åŠ é€»è¾‘åº”ç”¨ä½œä¸ºæ’ä»¶ï¼ˆä»…é™C#ï¼‰</strong></p>
<h2 id="å»ºç«‹å¯¹è¯æœåŠ¡ç¡®å®šä¸Šè¿°æœåŠ¡å">å»ºç«‹å¯¹è¯æœåŠ¡ï¼ˆç¡®å®šä¸Šè¿°æœåŠ¡åï¼‰<a hidden class="anchor" aria-hidden="true" href="#å»ºç«‹å¯¹è¯æœåŠ¡ç¡®å®šä¸Šè¿°æœåŠ¡å">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Build the kernel and retrieve services</span>
</span></span><span style="display:flex;"><span>chat_completion : AzureChatCompletion <span style="color:#f92672">=</span> kernel<span style="color:#f92672">.</span>get_service(type<span style="color:#f92672">=</span>ChatCompletionClientBase)
</span></span></code></pre></div><h2 id="åˆ›å»ºå†å²å¯¹è¯å¹¶è®¾ç½®prompt">åˆ›å»ºå†å²å¯¹è¯ï¼Œå¹¶è®¾ç½®prompt<a hidden class="anchor" aria-hidden="true" href="#åˆ›å»ºå†å²å¯¹è¯å¹¶è®¾ç½®prompt">#</a></h2>
<p>æ–¹æ³•ä¸€</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Create a history of the conversation</span>
</span></span><span style="display:flex;"><span>history <span style="color:#f92672">=</span> ChatHistory(system_message<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    You are a friendly assistant who likes to follow the rules. You will complete required steps
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    and request approval before taking any consequential actions. If the user doesn&#39;t provide
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    enough information for you to complete a task, you will keep asking questions until you have
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    enough information to complete the task.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>)
</span></span></code></pre></div><p>æ–¹æ³•äºŒ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># æ·»åŠ system_messageç¬¬äºŒç§æ–¹æ³•</span>
</span></span><span style="display:flex;"><span>chat_history <span style="color:#f92672">=</span> ChatHistory()
</span></span><span style="display:flex;"><span>chat_history<span style="color:#f92672">.</span>add_system_message(<span style="color:#e6db74">&#34;You are a helpful assistant.&#34;</span>)
</span></span></code></pre></div><p>æ–¹æ³•ä¸‰</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Add system messageï¼Œç¬¬ä¸‰ç§æ–¹æ³•</span>
</span></span><span style="display:flex;"><span>history <span style="color:#f92672">=</span> ChatHistory()
</span></span><span style="display:flex;"><span>chat_history<span style="color:#f92672">.</span>add_message(
</span></span><span style="display:flex;"><span>    ChatMessage(
</span></span><span style="display:flex;"><span>        role<span style="color:#f92672">=</span>AuthorRole<span style="color:#f92672">.</span>System,
</span></span><span style="display:flex;"><span>        content<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;You are a helpful assistant&#34;</span>
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><h2 id="æ·»åŠ ç”¨æˆ·è¾“å…¥è®°å½•">æ·»åŠ ç”¨æˆ·è¾“å…¥è®°å½•<a hidden class="anchor" aria-hidden="true" href="#æ·»åŠ ç”¨æˆ·è¾“å…¥è®°å½•">#</a></h2>
<p>æ–¹æ³•ä¸€ï¼šæ–‡æœ¬</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>history<span style="color:#f92672">.</span>add_user_message(user_input)
</span></span></code></pre></div><p>æ–¹æ³•äºŒï¼šæ–‡æœ¬</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Add additional message from a different userï¼Œç¬¬äºŒç§æ–¹æ³•ï¼Œå¯ä»¥æŒ‡å®šname</span>
</span></span><span style="display:flex;"><span>chat_history<span style="color:#f92672">.</span>add_message(
</span></span><span style="display:flex;"><span>    ChatMessageContent(
</span></span><span style="display:flex;"><span>        role<span style="color:#f92672">=</span>AuthorRole<span style="color:#f92672">.</span>USER,
</span></span><span style="display:flex;"><span>        name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Ema Vargova&#34;</span>,
</span></span><span style="display:flex;"><span>        content<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;I&#39;d like to have the first option, please.&#34;</span>
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p>æ–¹æ³•ä¸‰ï¼šæ·»åŠ å›¾ç‰‡</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Add user message with an image</span>
</span></span><span style="display:flex;"><span>chat_history<span style="color:#f92672">.</span>add_message(
</span></span><span style="display:flex;"><span>    ChatMessageContent(
</span></span><span style="display:flex;"><span>        role<span style="color:#f92672">=</span>AuthorRole<span style="color:#f92672">.</span>USER,
</span></span><span style="display:flex;"><span>        name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Laimonis Dumins&#34;</span>,
</span></span><span style="display:flex;"><span>        items<span style="color:#f92672">=</span>[
</span></span><span style="display:flex;"><span>            TextContent(text<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;What available on this menu&#34;</span>),
</span></span><span style="display:flex;"><span>            ImageContent(uri<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://example.com/menu.jpg&#34;</span>)
</span></span><span style="display:flex;"><span>        ]
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><h2 id="æ‰§è¡Œå¯¹è¯è·å¾—å›å¤">æ‰§è¡Œå¯¹è¯ï¼Œè·å¾—å›å¤<a hidden class="anchor" aria-hidden="true" href="#æ‰§è¡Œå¯¹è¯è·å¾—å›å¤">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Get the response from the AI</span>
</span></span><span style="display:flex;"><span>result <span style="color:#f92672">=</span> (<span style="color:#66d9ef">await</span> chat_completion<span style="color:#f92672">.</span>get_chat_message_contents(  
</span></span><span style="display:flex;"><span>    chat_history<span style="color:#f92672">=</span>history,
</span></span><span style="display:flex;"><span>    settings<span style="color:#f92672">=</span>execution_settings,
</span></span><span style="display:flex;"><span>    kernel<span style="color:#f92672">=</span>kernel,
</span></span><span style="display:flex;"><span>    arguments<span style="color:#f92672">=</span>KernelArguments(),
</span></span><span style="display:flex;"><span>))[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Print the response</span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;Assistant &gt; &#34;</span> <span style="color:#f92672">+</span> str(result))
</span></span></code></pre></div><h2 id="æ·»åŠ aiå“åº”è®°å½•">æ·»åŠ AIå“åº”è®°å½•<a hidden class="anchor" aria-hidden="true" href="#æ·»åŠ aiå“åº”è®°å½•">#</a></h2>
<p>æ–¹æ³•ä¸€</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>history<span style="color:#f92672">.</span>add_assistant_message(str(result))
</span></span></code></pre></div><p>æ–¹æ³•äºŒ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Add assistant messageï¼Œç¬¬äºŒç§æ–¹æ³•ï¼Œå¯ä»¥æŒ‡å®šname</span>
</span></span><span style="display:flex;"><span>chat_history<span style="color:#f92672">.</span>add_message(
</span></span><span style="display:flex;"><span>    ChatMessageContent(
</span></span><span style="display:flex;"><span>        role<span style="color:#f92672">=</span>AuthorRole<span style="color:#f92672">.</span>ASSISTANT,
</span></span><span style="display:flex;"><span>        name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Restaurant Assistant&#34;</span>,
</span></span><span style="display:flex;"><span>        content<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;We have pizza, pasta, and salad available to order. What would you like to order?&#34;</span>
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><h2 id="ä½¿ç”¨skå®ç°rag">ä½¿ç”¨SKå®ç°RAG<a hidden class="anchor" aria-hidden="true" href="#ä½¿ç”¨skå®ç°rag">#</a></h2>
<p>å‚è€ƒï¼šhttps://github.com/john0isaac/rag-semantic-kernel-mongodb-vcore/blob/main/rag-azure-openai-cosmosdb-notebook.ipynb
<strong>è®¾ç½®ä¸€äº›å‚æ•°</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># collection name will be used multiple times in the code so we store it in a variable</span>
</span></span><span style="display:flex;"><span>collection_name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;VectorSearchCollection&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Vector search index parameters</span>
</span></span><span style="display:flex;"><span>index_name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;VectorSearchIndex&#34;</span>
</span></span><span style="display:flex;"><span>vector_dimensions <span style="color:#f92672">=</span> <span style="color:#ae81ff">1536</span>  <span style="color:#75715e"># text-embedding-ada-002 uses a 1536-dimensional embedding vector</span>
</span></span><span style="display:flex;"><span>num_lists <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>similarity <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;COS&#34;</span>  <span style="color:#75715e"># cosine distance</span>
</span></span></code></pre></div><p><strong>é…ç½®LLMChatã€embeddingæ¨¡å‹</strong></p>
<p>1.Azure</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> semantic_kernel <span style="color:#f92672">import</span> Kernel
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> dotenv <span style="color:#f92672">import</span> load_dotenv, find_dotenv
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> semantic_kernel.connectors.ai.open_ai <span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>    AzureChatCompletion,
</span></span><span style="display:flex;"><span>    AzureTextEmbedding,
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Intialize the kernel</span>
</span></span><span style="display:flex;"><span>kernel <span style="color:#f92672">=</span> Kernel()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># adding azure openai chat service</span>
</span></span><span style="display:flex;"><span>chat_model_deployment_name <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>environ<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;AZURE_OPENAI_CHAT_DEPLOYMENT_NAME&#34;</span>)
</span></span><span style="display:flex;"><span>endpoint <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>environ<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;AZURE_OPENAI_ENDPOINT&#34;</span>)
</span></span><span style="display:flex;"><span>api_key <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>environ<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;AZURE_OPENAI_API_KEY&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kernel<span style="color:#f92672">.</span>add_service(
</span></span><span style="display:flex;"><span>    AzureChatCompletion(
</span></span><span style="display:flex;"><span>        service_id<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;chat_completion&#34;</span>,
</span></span><span style="display:flex;"><span>        deployment_name<span style="color:#f92672">=</span>chat_model_deployment_name,
</span></span><span style="display:flex;"><span>        endpoint<span style="color:#f92672">=</span>endpoint,
</span></span><span style="display:flex;"><span>        api_key<span style="color:#f92672">=</span>api_key,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span><span style="color:#75715e"># adding azure openai text embedding service</span>
</span></span><span style="display:flex;"><span>embedding_model_deployment_name <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>environ<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;AZURE_OPENAI_EMBEDDINGS_DEPLOYMENT_NAME&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kernel<span style="color:#f92672">.</span>add_service(
</span></span><span style="display:flex;"><span>    AzureTextEmbedding(
</span></span><span style="display:flex;"><span>        service_id<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;text_embedding&#34;</span>,
</span></span><span style="display:flex;"><span>        deployment_name<span style="color:#f92672">=</span>embedding_model_deployment_name,
</span></span><span style="display:flex;"><span>        endpoint<span style="color:#f92672">=</span>endpoint,
</span></span><span style="display:flex;"><span>        api_key<span style="color:#f92672">=</span>api_key,
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p>2.openai</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> semantic_kernel <span style="color:#f92672">import</span> Kernel
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> dotenv <span style="color:#f92672">import</span> load_dotenv, find_dotenv
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> semantic_kernel.connectors.ai.open_ai <span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>    AzureChatCompletion,
</span></span><span style="display:flex;"><span>    AzureTextEmbedding,
</span></span><span style="display:flex;"><span>    OpenAIChatCompletion,
</span></span><span style="display:flex;"><span>    OpenAITextEmbedding<span style="color:#960050;background-color:#1e0010">ï¼Œ</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Intialize the kernel</span>
</span></span><span style="display:flex;"><span>kernel <span style="color:#f92672">=</span> Kernel()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>openai_api_key <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#34;OPENAI_API_KEY&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Add the OpenAI service</span>
</span></span><span style="display:flex;"><span>kernel<span style="color:#f92672">.</span>add_service(OpenAIChatCompletion(
</span></span><span style="display:flex;"><span>    ai_model_id<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;gpt-4o-mini-2024-07-18&#34;</span>,
</span></span><span style="display:flex;"><span>    api_key<span style="color:#f92672">=</span>os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#34;OPENAI_API_KEY&#34;</span>)
</span></span><span style="display:flex;"><span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kernel<span style="color:#f92672">.</span>add_service(
</span></span><span style="display:flex;"><span>    embedding_gen <span style="color:#f92672">=</span> OpenAITextEmbedding(
</span></span><span style="display:flex;"><span>        ai_model_id<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;text-embedding-3-small&#34;</span>,
</span></span><span style="display:flex;"><span>        api_key <span style="color:#f92672">=</span> openai_api_key
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p><strong>é…ç½®å‘é‡æ•°æ®åº“</strong>
<a href="https://learn.microsoft.com/en-us/python/api/semantic-kernel/semantic_kernel.connectors.memory.chroma.chroma_memory_store.chromamemorystore?view=semantic-kernel-python">semantic kernelçš„API</a>ä¸­çš„æ”¯æŒæœ¬åœ°æ•°æ®åº“ï¼Œäº‘æ•°æ®åº“å¸¸ç”¨Azureè¾ƒå¤šã€‚
æ³¨æ„ï¼šæš‚ä¸æ”¯æŒpineconeäº‘æ•°æ®åº“ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> semantic_kernel.connectors.memory.azure_cosmosdb <span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>    AzureCosmosDBMemoryStore,
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;Creating or updating Azure Cosmos DB Memory Store...&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># create azure cosmos db for mongo db vcore api store and collection with vector ivf</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># currently, semantic kernel only supports the ivf vector kind</span>
</span></span><span style="display:flex;"><span>store <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> AzureCosmosDBMemoryStore<span style="color:#f92672">.</span>create(
</span></span><span style="display:flex;"><span>    cosmos_connstr<span style="color:#f92672">=</span>os<span style="color:#f92672">.</span>environ<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;AZCOSMOS_CONNSTR&#34;</span>),
</span></span><span style="display:flex;"><span>    cosmos_api<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;mongo-vcore&#34;</span>,
</span></span><span style="display:flex;"><span>    database_name<span style="color:#f92672">=</span>os<span style="color:#f92672">.</span>environ<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;AZCOSMOS_DATABASE_NAME&#34;</span>),
</span></span><span style="display:flex;"><span>    collection_name<span style="color:#f92672">=</span>collection_name,
</span></span><span style="display:flex;"><span>    index_name<span style="color:#f92672">=</span>index_name,
</span></span><span style="display:flex;"><span>    vector_dimensions<span style="color:#f92672">=</span>vector_dimensions,
</span></span><span style="display:flex;"><span>    num_lists<span style="color:#f92672">=</span>num_lists,
</span></span><span style="display:flex;"><span>    similarity<span style="color:#f92672">=</span>similarity,
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;Finished updating Azure Cosmos DB Memory Store...&#34;</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> semantic_kernel.memory.semantic_text_memory <span style="color:#f92672">import</span> SemanticTextMemory
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> semantic_kernel.core_plugins.text_memory_plugin <span style="color:#f92672">import</span> TextMemoryPlugin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>memory <span style="color:#f92672">=</span> SemanticTextMemory(storage<span style="color:#f92672">=</span>store, embeddings_generator<span style="color:#f92672">=</span>kernel<span style="color:#f92672">.</span>get_service(<span style="color:#e6db74">&#34;text_embedding&#34;</span>))
</span></span><span style="display:flex;"><span>kernel<span style="color:#f92672">.</span>add_plugin(TextMemoryPlugin(memory), <span style="color:#e6db74">&#34;TextMemoryPluginACDB&#34;</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;Registered Azure Cosmos DB Memory Store...&#34;</span>)
</span></span></code></pre></div><p><strong>ç”ŸæˆåµŒå…¥å¹¶åˆ›å»ºæ•°æ®åº“è®°å½•</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> semantic_kernel.memory.semantic_text_memory <span style="color:#f92672">import</span> SemanticTextMemory
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> semantic_kernel.memory.memory_store_base <span style="color:#f92672">import</span> MemoryStoreBase
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">upsert_data_to_memory_store</span>(memory: SemanticTextMemory, store: MemoryStoreBase, data_file_path: str) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    This asynchronous function takes two memory stores and a data file path as arguments.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    It is designed to upsert (update or insert) data into the memory stores from the data file.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Args:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        memory (callable): A callable object that represents the semantic kernel memory.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        store (callable): A callable object that represents the memory store where data will be upserted.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        data_file_path (str): The path to the data file that contains the data to be upserted.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Returns:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        None. The function performs an operation that modifies the memory stores in-place.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> open(file<span style="color:#f92672">=</span>data_file_path, mode<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;r&#34;</span>, encoding<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;utf-8&#34;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>        data <span style="color:#f92672">=</span> json<span style="color:#f92672">.</span>load(f)
</span></span><span style="display:flex;"><span>        n <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> item <span style="color:#f92672">in</span> data:
</span></span><span style="display:flex;"><span>            n <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># check if the item already exists in the memory store</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># if the id doesn&#39;t exist, it throws an exception</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>                already_created <span style="color:#f92672">=</span> bool(<span style="color:#66d9ef">await</span> store<span style="color:#f92672">.</span>get(collection_name, item[<span style="color:#e6db74">&#34;id&#34;</span>], with_embedding<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>))
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span>:
</span></span><span style="display:flex;"><span>                already_created <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># if the record doesn&#39;t exist, we generate embeddings and save it to the database</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> already_created:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">await</span> memory<span style="color:#f92672">.</span>save_information(
</span></span><span style="display:flex;"><span>                    collection<span style="color:#f92672">=</span>collection_name,
</span></span><span style="display:flex;"><span>                    id<span style="color:#f92672">=</span>item[<span style="color:#e6db74">&#34;id&#34;</span>],
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e"># the embedding is generated from the text field</span>
</span></span><span style="display:flex;"><span>                    text<span style="color:#f92672">=</span>item[<span style="color:#e6db74">&#34;content&#34;</span>],
</span></span><span style="display:flex;"><span>                    description<span style="color:#f92672">=</span>item[<span style="color:#e6db74">&#34;title&#34;</span>],
</span></span><span style="display:flex;"><span>                )
</span></span><span style="display:flex;"><span>                print(
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;Generating embeddings and saving new item:&#34;</span>,
</span></span><span style="display:flex;"><span>                    n,
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;/&#34;</span>,
</span></span><span style="display:flex;"><span>                    len(data),
</span></span><span style="display:flex;"><span>                    end<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>                )
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                print(<span style="color:#e6db74">&#34;Skipping item already exits:&#34;</span>, n, <span style="color:#e6db74">&#34;/&#34;</span>, len(data), end<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r</span><span style="color:#e6db74">&#34;</span>)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># cleaned-top-movies-chunked.json contains the top 344 movie from the IMDB movies dataset</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># You can also try the text-sample.json which contains 107 Azure Service.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Replace the file name cleaned-top-movies-chunked.json with text-sample.json</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ç”ŸæˆåµŒå…¥å¹¶åˆ›å»ºæ•°æ®åº“è®°å½•</span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;Upserting data to Azure Cosmos DB Memory Store...&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">await</span> upsert_data_to_memory_store(memory, store, <span style="color:#e6db74">&#34;./src/data/cleaned-top-movies-chunked.json&#34;</span>)
</span></span></code></pre></div><p><strong>ï¼ˆå¯é€‰ï¼‰æµ‹è¯•å‘é‡æ•°æ®åº“</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># each time it calls the embedding model to generate embeddings from your query</span>
</span></span><span style="display:flex;"><span>query_term <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;What do you know about the godfather?&#34;</span>
</span></span><span style="display:flex;"><span>result <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> memory<span style="color:#f92672">.</span>search(collection_name, query_term)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Result is: </span><span style="color:#e6db74">{</span>result[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>text<span style="color:#e6db74">}</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Relevance Score: </span><span style="color:#e6db74">{</span>result[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>relevance<span style="color:#e6db74">}</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Full Record: </span><span style="color:#e6db74">{</span>result[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>additional_metadata<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p><strong>RAG flow</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 1.è®¾ç½®prompt</span>
</span></span><span style="display:flex;"><span>prompt <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Give explicit answers from the provided context or say &#39;I don&#39;t know&#39; if it does not have an answer.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    provided context: {{$db_record}}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    User: {{$query_term}}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Chatbot:&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> semantic_kernel.connectors.ai.open_ai <span style="color:#f92672">import</span> OpenAITextPromptExecutionSettings
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2.æŒ‡å®škernelä¸­çš„LLMï¼Œå¹¶è®¾ç½®å‚æ•°</span>
</span></span><span style="display:flex;"><span>execution_settings <span style="color:#f92672">=</span> OpenAITextPromptExecutionSettings(
</span></span><span style="display:flex;"><span>    service_id<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;chat_completion&#34;</span>, ai_model_id<span style="color:#f92672">=</span>chat_model_deployment_name, max_tokens<span style="color:#f92672">=</span><span style="color:#ae81ff">500</span>, temperature<span style="color:#f92672">=</span><span style="color:#ae81ff">0.0</span>, top_p<span style="color:#f92672">=</span><span style="color:#ae81ff">0.5</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> semantic_kernel.prompt_template <span style="color:#f92672">import</span> PromptTemplateConfig
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> semantic_kernel.prompt_template.input_variable <span style="color:#f92672">import</span> InputVariable
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 3.é…ç½®chatåŠŸèƒ½</span>
</span></span><span style="display:flex;"><span>chat_prompt_hist_template_config <span style="color:#f92672">=</span> PromptTemplateConfig(
</span></span><span style="display:flex;"><span>    template<span style="color:#f92672">=</span>prompt,
</span></span><span style="display:flex;"><span>    name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;grounded_response_history&#34;</span>,
</span></span><span style="display:flex;"><span>    template_format<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;semantic-kernel&#34;</span>,
</span></span><span style="display:flex;"><span>    input_variables<span style="color:#f92672">=</span>[
</span></span><span style="display:flex;"><span>        InputVariable(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;db_record&#34;</span>, description<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;The database record&#34;</span>, is_required<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>),
</span></span><span style="display:flex;"><span>        InputVariable(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;query_term&#34;</span>, description<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;The user input&#34;</span>, is_required<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>),
</span></span><span style="display:flex;"><span>        InputVariable(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;history&#34;</span>, description<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;The chat histroy&#34;</span>, is_required<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>),
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    execution_settings<span style="color:#f92672">=</span>execution_settings,
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>chat_history_function <span style="color:#f92672">=</span> kernel<span style="color:#f92672">.</span>add_function(
</span></span><span style="display:flex;"><span>    function_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ChatGPTFuncHist&#34;</span>, plugin_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;chatGPTPluginHist&#34;</span>, prompt_template_config<span style="color:#f92672">=</span>chat_prompt_hist_template_config
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 4.è°ƒç”¨</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> semantic_kernel.functions <span style="color:#f92672">import</span> KernelArguments
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> semantic_kernel.contents <span style="color:#f92672">import</span> ChatHistory
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> time
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>chat_history <span style="color:#f92672">=</span> ChatHistory()
</span></span><span style="display:flex;"><span>chat_history<span style="color:#f92672">.</span>add_system_message(<span style="color:#e6db74">&#34;You are a helpful chatbot who is good about giving movie recommendations.&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>query_term <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>search_result <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>completions_result <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> query_term <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;exit&#34;</span>:
</span></span><span style="display:flex;"><span>    query_term <span style="color:#f92672">=</span> input(<span style="color:#e6db74">&#34;Enter a query: &#34;</span>)
</span></span><span style="display:flex;"><span>    chat_history<span style="color:#f92672">.</span>add_user_message(query_term)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    search_result <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> memory<span style="color:#f92672">.</span>search(collection_name, query_term) <span style="color:#75715e"># vector search</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    completions_result <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> kernel<span style="color:#f92672">.</span>invoke(
</span></span><span style="display:flex;"><span>        chat_history_function, KernelArguments(query_term<span style="color:#f92672">=</span>query_term, db_record<span style="color:#f92672">=</span>search_result[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>additional_metadata)
</span></span><span style="display:flex;"><span>    ) 
</span></span><span style="display:flex;"><span>    chat_history<span style="color:#f92672">.</span>add_assistant_message(str(completions_result))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Question:</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">{</span>query_term<span style="color:#e6db74">}</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Response:&#34;</span>)
</span></span><span style="display:flex;"><span>    print(str(completions_result), end<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">5</span>)
</span></span></code></pre></div>

        </div>
        <div class="post-reward">
            <div style="padding: 0 0 0 0; margin: 0 0 0 0; width: 100%; font-size:16px; text-align: center;">
                <div id="QR" style="opacity: 0;">
                    <div id="wechat" style="display: inline-block">
                        <a class="fancybox" rel="group">
                            <img id="wechat_qr" src="https://Aliga123.github.io/img/wechat_pay.jpg" alt="wechat_pay"></a>
                        <p>å¾®ä¿¡</p>
                    </div>
                    <div id="alipay" style="display: inline-block">
                        <a class="fancybox" rel="group">
                            <img id="alipay_qr" src="https://Aliga123.github.io/img/alipay.jpg" alt="alipay"></a>
                        <p>æ”¯ä»˜å®</p>
                    </div>
                </div>
                <button id="rewardButton"
                        onclick="
                    var qr = document.getElementById('QR');
                    if (qr.style.opacity === '0') {
                        qr.style.opacity='1';
                    } else {
                        qr.style.opacity='0'
                    }"
                >
                    <span>ğŸ§§ é¼“åŠ±</span>
                </button>
            </div>
        </div>

        <footer class="post-footer">
            
<nav class="paginav">
  <a class="prev" href="https://Aliga123.github.io/posts/ai-llm/rag/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>RAG</span>
  </a>
  <a class="next" href="https://Aliga123.github.io/posts/ai-llm/%E4%BD%BF%E7%94%A8.env%E6%96%87%E4%BB%B6%E4%BF%9D%E5%AD%98key%E5%8F%98%E9%87%8F/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>ä½¿ç”¨.envæ–‡ä»¶ä¿å­˜keyå˜é‡</span>
  </a>
</nav>

        </footer>
    </div>

<style>
    .comments_details summary::marker {
        font-size: 20px;
        content: 'ğŸ‘‰å±•å¼€è¯„è®º';
        color: var(--content);
    }
    .comments_details[open] summary::marker{
        font-size: 20px;
        content: 'ğŸ‘‡å…³é—­è¯„è®º';
        color: var(--content);
    }
</style>


<div>
    <details class="comments_details">
        <summary style="cursor: pointer; margin: 50px 0 20px 0;width: 130px;">
            <span style="font-size: 20px;color: var(--content);">...</span>
        </summary>
        <div id="tcomment"></div>
    </details>
    <script src="https://cdn.staticfile.org/twikoo/1.5.8/twikoo.all.min.js">
    </script>
    <script>
        twikoo.init({
            envId:  null ,
        el: "#tcomment",
            lang: 'zh-CN',
            region:  null ,
        path: window.TWIKOO_MAGIC_PATH||window.location.pathname,
        })
    </script>
</div>
</article>
</main>

<footer class="footer">
    <span>
        Copyright
        &copy;
        2020-2024
        <a href="https://Aliga123.github.io/" style="color:#939393;">aliga&#39;s Blog</a>
        All Rights Reserved
    </span>
    <a href="https://beian.miit.gov.cn/" target="_blank" style="color:#939393;">å¡«å†™è‡ªå·±çš„å¤‡æ¡ˆå·</a>&nbsp;
    <span>
        <a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=null"
           style="display:inline-block;text-decoration:none;height:20px;color:#939393;">
            <img src="%e5%a1%ab%e8%87%aa%e5%b7%b1%e7%9a%84%e5%85%ac%e5%ae%89%e5%9b%be%e6%a0%87%e9%93%be%e6%8e%a5" style="float:left;margin: 0px 5px 0px 0px;"/>
            å¡«è‡ªå·±çš„å…¬ç½‘å®‰å¤‡
        </a>
    </span>
    <span id="busuanzi_container">
        <span class="fa fa-user"></span> <span id="busuanzi_value_site_uv"></span>
        <span class="fa fa-eye"></span> <span id="busuanzi_value_site_pv"></span>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <span class="topInner">
        <svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z"/>
        </svg>
        <span id="read_progress"></span>
    </span>
</a>

<script>
    document.addEventListener('scroll', function (e) {
        const readProgress = document.getElementById("read_progress");
        const scrollHeight = document.documentElement.scrollHeight;
        const clientHeight = document.documentElement.clientHeight;
        const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
        readProgress.innerText = ((scrollTop / (scrollHeight - clientHeight)).toFixed(2) * 100).toFixed(0);
    })
</script>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });
</script>
<script>
    let mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };
</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        (function() {
            document.cookie = "change-themes" + "="+ escape ("false");
        })()

        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    });
</script>

<script>
    document.body.addEventListener('copy', function (e) {
        if (window.getSelection().toString() && window.getSelection().toString().length > 50) {
            let clipboardData = e.clipboardData || window.clipboardData;
            if (clipboardData) {
                e.preventDefault();
                let htmlData = window.getSelection().toString() +
                    '\r\n\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ'+"aliga's Blog"+'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                let textData = window.getSelection().toString() +
                    '\r\n\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ'+"aliga's Blog"+'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                clipboardData.setData('text/html', htmlData);
                clipboardData.setData('text/plain', textData);
            }
        }
    });
</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;
        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = 'å¤åˆ¶';

        function copyingDone() {
            copybutton.innerText = 'å·²å¤åˆ¶ï¼';
            setTimeout(() => {
                copybutton.innerText = 'å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                let text = codeblock.textContent +
                    '\r\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ'+"aliga's Blog"+'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                navigator.clipboard.writeText(text);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) {}
            selection.removeRange(range);
        });

        let language = codeblock.className.replaceAll("language-", "")
        let macTool = document.createElement("div")
        let macTool1 = document.createElement("div")
        let macTool2 = document.createElement("div")
        let macTool3 = document.createElement("div")
        let languageType = document.createElement("div")
        languageType.innerText = language
        macTool.setAttribute('class', 'mac-tool')
        macTool1.setAttribute('class', 'mac bb1')
        macTool2.setAttribute('class', 'mac bb2')
        macTool3.setAttribute('class', 'mac bb3')
        languageType.setAttribute('class', 'language-type')
        macTool.appendChild(macTool1)
        macTool.appendChild(macTool2)
        macTool.appendChild(macTool3)
        macTool.appendChild(languageType)

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
            container.appendChild(macTool)
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
            container.appendChild(macTool)
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
            container.appendChild(macTool)
        }
    });
</script>
</body>

</html>
